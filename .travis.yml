language: php

php:
  - 5.3
  - 5.4

env:
  - DB=application

before_script:
  - "sudo apt-get -qq update"
  - "sudo apt-get -y -qq install lighttpd"
  - "sudo apt-get -y -qq install php5-cgi"
  - "sudo echo 'cgi.fix_pathinfo = 1' >> sudo /etc/php5/cgi/php.ini"
  - ls /usr/local/bin
  - sudo cp /etc/lighttpd/lighttpd.conf /etc/lighttpd/lighttpd.conf.new
  - sudo sed 's/mod_accesslog/mod_fastcgi/g' /etc/lighttpd/lighttpd.conf > sudo /etc/lighttpd/lighttpd.conf.new
  - sudo echo 'fastcgi.server = ( ".php" => ((' >> sudo /etc/lighttpd/lighttpd.conf.new
  - sudo echo '"bin-path" => "/usr/bin/php5-cgi",' >> sudo /etc/lighttpd/lighttpd.conf.new
  - sudo echo '"socket" => "/tmp/php.socket"' >> sudo /etc/lighttpd/lighttpd.conf.new
  - sudo echo ')))' >> sudo /etc/lighttpd/lighttpd.conf.new
  - sudo mv /etc/lighttpd/lighttpd.conf.new /etc/lighttpd/lighttpd.conf
  - sudo /etc/init.d/lighttpd restart
  - "sleep 4"
  - "sudo echo '<?php phpinfo() ?>' >> sudo /var/www/test.php"
  - "curl -v http://127.0.0.1/test.php"
  - "sudo mkdir /var/www/codeigniter"
  - "sudo chmod 777 /var/www/codeigniter -R"
  - "sudo cp index.php /var/www/codeigniter/index.php"
  - "sudo cp application/ /var/www/codeigniter/ -r"
  - "sudo cp system/ /var/www/codeigniter/ -r"
  - "curl -v http://127.0.0.1/codeigniter"

script: phpunit --configuration tests/travis/$DB.phpunit.xml

branches:
  only:
    - develop
    - master
    - application-tests